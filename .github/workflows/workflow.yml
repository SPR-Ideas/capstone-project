name: Build and Publish Docker Images
on:
  push:
    paths:
      - 'Auth/Auth/**'
      - 'inventory/inventory/**'
      - 'Gateway/Gateway/**'
      - 'Matches/Matches/**'
    branches:
      - main

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  CONTAINER_REGISTRY: gullycricket.azurecr.io

jobs:
  build_and_publish:
    runs-on: ubuntu-latest
    steps:
          - name: Checkout code
            uses: actions/checkout@v2

          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v1

          - name: Log in to Container Registry
            run: docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD $CONTAINER_REGISTRY

          - name: Determine modified microservices
            id: determine_microservices
            run: |
              # Get the list of modified microservice directories
              modified_dirs=$(git diff --name-only HEAD~1 HEAD | grep -oE 'Auth/Auth|inventory/inventory|Gateway/Gateway|Matches/Matches')
              echo "::set-output name=modified_dirs::$modified_dirs"

          - name: Build and push Docker images
            run: |
              docker buildx create --use

              # Build and push modified microservices
              for dir in ${{ steps.determine_microservices.outputs.modified_dirs }}
              do
                docker buildx build --platform linux/amd64,linux/arm64 --push -t $CONTAINER_REGISTRY/microservices/${dir,,}:latest ./$dir
              done

  execute_commands:
    needs : build_and_publish
    runs-on: ubuntu-latest
    steps:
    - name: Connect to VM via SSH
      uses: appleboy/ssh-action@master
      with:
        host: 172.190.178.221
        username: ${{ secrets.AZURE_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sudo docker-compose down
          sudo docker-compose pull
          sudo docker-compose up -d
